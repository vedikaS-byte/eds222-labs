---
title: "Lab 7: The Color of Drinking Water"
format: html
---

# Lab 7: The Color of Drinking Water

In today’s lab you will…

-   Fit logistic regression models to binary (0/1, no/yes) outcomes
-   Interpret coefficients
-   Visualize predictions

Complete sections Logistic model notation and R code and Read and explore the data before class.

```{r}
#| output: false
library(tidyverse)
theme_set(theme_classic(12))
set.seed(123)
```

## Logistic model notation and R code

In statistical notation, logistic models take the form:

![](images/clipboard-2827239717.png)

**In both the notation and code above, identify the:**

-   **Response family:** Binomial

-   **Link function:** logit()

-   **Response:** BinaryOutcome

-   **Predictor:** Probability of favored outcome?

```{r}
logistic_model <- glm(binary_outcome ~ predictor,
                      data = my_data,
                      family = binomial(link = "logit"))
```

## **Read and explore the data**

```{r}
drinking_water <- read_csv(here::here("data_copy","drinking_water.csv"))
str(drinking_water)
unique(drinking_water$health)
```

**Describe what you think each of the columns represents.**

| Column | Meaning |
|------------------------|------------------------------------------------|
| `pwsid` | ID for each water drinking water source |
| `pwsname` | Name of each drinking water source |
| `pctpov` | Percent poverty |
| `pcthisp` | Percent Hispanic population |
| `health` | Number of health violations |
| `medianincomehouse` | Median income of households |
| `violation` | Binary (Boolean) of whether a drinking site is "safe" or not |
| `pcthisp_bin` | Binned percentiles for % Hispanic |
| `pctpov_bin` | Binned percentiles for % poverty |

**Create three figures summarizing the relationships between race, class, and SDWA violations.**

Figure 1: A scatter plot showing the *proportion* of districts with SDWA violations in each *percent Hispanic bin*.

```{r}
drinking_water %>%
  group_by(pcthisp_bin) %>%
  summarise(prop_violation = mean(violation, na.rm = TRUE)) %>%
ggplot(aes(x = pcthisp_bin, y = prop_violation)) +
  geom_point(color = "darkblue") +
  geom_line(group = 1, color = "darkblue") +
  labs(
    x = "Binned Percent Hispanic",
    y = "Proportion with SDWA Violations",
    title = "Proportion of Districts with SDWA Violations by % Hispanic Bin"
  ) +
  theme_minimal()

```

Figure 2: A scatter plot showing the *proportion* of districts with SDWA violations in each *percent below-poverty bin*.

```{r}
drinking_water %>%
  group_by(pctpov_bin) %>%
  summarise(prop_violation = mean(violation, na.rm = TRUE)) %>%
ggplot(aes(x = pctpov_bin, y = prop_violation)) +
  geom_point(color = "darkred") +
  geom_line(group = 1, color = "darkred") +
  labs(
    x = "Percent Below Poverty (binned)",
    y = "Proportion with SDWA Violations",
    title = "Proportion of Districts with SDWA Violations by % Below Poverty Bin"
  ) +
  theme_minimal()

```

Figure 3: A scatter plot showing the correlation between *percent Hispanic* and *percent below-poverty* at the district level.

```{r}
drinking_water %>% 
ggplot(aes(x = pcthisp, y = pctpov)) +
  geom_point(alpha = 0.2, col = "lightblue") +
 # geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(
    x = "Percent Hispanic",
    y = "Percent Below Poverty",
    title = "Relationship Between % Hispanic and % Below Poverty at the \nDistrict Level"
  ) +
  theme_minimal()
```

## Fit and interpret model

Our question is:

*How are SDWA violations distributed among communities by class and race?*

Let’s begin by investigating class in isolation. **Fit a logistic model to see how `violation` responds to `pctpov`**.

```{r}
class_model <- glm(violation~pctpov, # formula: response ~ predictors
                   data = drinking_water, 
                   family = binomial(link = "logit")) # Set family response

summary(class_model)$coefficients["pctpov",4]
confint(class_model)["pctpov",]

```

Just as we did with linear regression, you can inspect coefficient estimates, p-values, and confidence intervals using `summary()` and `confint()`.

**What is the best estimate for the % Below Poverty coefficient?**

The best estimate for % below poverty coefficient is about 0.016980.

**Is the coefficient significantly different than 0? Assume critical threshold of 0.05.**

The coefficient is significantly different from 0 (p\<.05).

**What is the 95% CI for the coefficient?**

We are 95% confident that that the true population coefficient of percent poverty for the number of violations at different sources of drinking water falls between 0.014 and 0.02.

**Based on the sign, what is the relationship between class and SDWA violations?**

There is a positive statistically significant relationship (positive association) between percent poverty and the number of violations.

## Making predictions

Interpreting the coefficients directly is pretty difficult with logistic regression! What is the difference between a coefficient of 0.1 and 0.2? Rather than interpreting the coefficient directly, it’s often easier to compare predictions.

Once you have a model, you can make predictions using `predict()`. When calling `predict()`, the following parameters are important:

-   `object` The model you want to generate predictions from

-   `newdata` A data frame of predictors your want predictions for

-   `type` Do you want predictions on the *link* or *response* scale? By default, `predict()` shows the value of (i.e., link-scale). To get the predicted *probability* (i.e., response-scale) set `type` to “response”.

-   `se.fit` If `se.fit` is `TRUE`, `predict()` will calculate the confidence interval of the response on the link scale. You can use that to get the confidence interval of . That will make a ribbon, similar to the confidence interval of you saw in linear regression.

Here’s how to generate predictions (with CI) for a single predictor.

```{r}
#| label: predict-class-model
# A grid of predictor(s) to generate predictions for 
pred_grid <- expand_grid(pctpov = 0:100)

# Generate predictions 
class_pred_grid <- pred_grid %>% 
  mutate(p = predict(object = class_model, 
                     newdata = pred_grid, 
                     type = "response")) # p, link will look at logit(p)

class_pred_grid
```

```{r}
#| label: plot-class-best-estimate

# p is the value of the line (curve)
class_pred_grid %>% ggplot(aes(pctpov, p)) + geom_line() + labs(title = "Predicted Class Model") + ylim(0,1) + 
  theme_bw()
```

```{r}
#| label: predict-class-model-link
# Calculations to get logit p and then undo with inverse function

# A grid of predictor(s) to generate predictions for 
pred_grid <- expand_grid(pctpov = 0:100)
class_model_se <-  predict(object = class_model, 
                     newdata = pred_grid, 
                     type = "link", # p, link will look at logit(p)
                     se.fit = T) # Get SE out of fit

# Go from link space to response space
linkinv <- family(class_model)$linkinv # Get back to p from logit(p)

class_model_predictions <- pred_grid %>% 
  mutate(#get logit(p)
    logit_p = class_model_se$fit, 
         # 95% CI in link space
    logit_p_se = class_model_se$se.fit, 
    logit_p_lwr = qnorm(.025, mean = logit_p, sd = logit_p_se), 
    logit_p_upper = qnorm(.975, mean = logit_p, sd = logit_p_se), 
    # undo link function using linkv
    p = linkinv(logit_p),
    p_lwr = linkinv(logit_p_lwr), 
    p_upper = linkinv(logit_p_upper))


head(class_model_predictions)

```

```{r}
#| label: class-model-link-predictions-plot

ggplot(class_model_predictions, aes(x = pctpov, y = p)) + 
  geom_ribbon(aes(ymin = p_lwr, ymax = p_upper), alpha= .2) +
  geom_line() + theme_bw()

```

And here’s the fit with the 95% CI presented as the familiar ribbon.

```{r}
# linkspace for meaningful math 
# inverse is for interpretation
## se.fit:logit(p) is linear with x predictor, apply inverse (logit^-1) to get p as y value (curve) against predictor




```

## Your turn 

Switzer and Teodoro demonstrated that the *interaction* between race and class is important for understanding the environmental justice dimensions of drinking water. You’ll investigate that here through the following steps.

1.  Create a new model with an interaction term between `pctpov` and `pcthisp`.

    ```{r}
    pov_pcthisp_model <- glm(violation~pctpov*pcthisp, 
                             data =drinking_water, 
                             binomial(link = "logit"))


    summary(pov_pcthisp_model)

    ```

2.  Use the summary and confidence intervals to answer the following questions:\
    **What is the 95% CI for the % Hispanic coefficient?**

    The 95% confidence interval for the % Hispanic coefficient falls between -0.009 and -0.002.

    \
    3. **Is the interaction between class and race significantly different than 0?**

    The interaction term is statistically significant.

```{r}
confint(pov_pcthisp_model)
```

1.  Create a new predictor data frame with combinations of *both* predictors.

```{r}
# Create new predictor data set 
predictions <- expand_grid(pctpov = 0:50, pcthisp = 0:100)
predictions
```

1.  Generate predictions, including both the best estimate and 95% CI.

    ```{r}
    # Make predictions with p 
    # need to undo logit p

    # Get the SE for logit 
    predictions_se <- predict(object = pov_pcthisp_model, newdata = predictions, type = "link",
                              se.fit = T)

    # Go from link space to response space
    linkinv <- family(pov_pcthisp_model)$linkinv

    # Create columns to predictions interaction to get the inverse ("p")
    class_predictions_interactions <- predictions %>% 
      mutate(
        # Get logit link
        logit_p = predictions_se$fit, 
        logit_p_se = predictions$se.fit, 
        logit_p_lwr = qnorm(.025, mean = logit_p, sd = logit_p_se), 
             logit_p_upper = qnorm(.025, mean = logit_p, sd = logit_p_se),
        # Undo logit link with inverse 
        p = linkinv(logit_p), 
        lower_p = linkinv(logit_p_lwr), 
        upper_p = linkiv(logit_p_upper)
        )

    ```

2.  Plot the predictions. In your plot, put `pcthisp` on the x-axis and probability of SDWA violations on the y-axis. Indicate `pctpov` using color and fill. To make this work, you’ll have to filter your predictions to a few levels of `pctpov` (e.g., 0, 25, 50, and 75).

The coefficient for an interaction term in a logistic regression model is very difficult to interpret on its own! But that value has important consequences for the lives of millions of people. Predictions are usually more straightforward to interpret than coefficients. Use your figure and the outputs of `summary()` and `confint()` to reflect on the following prompt. Reply to the corresponding thread on Slack with your reflection to get 1 token.

**In plain language, what is the relationship between race, class, and SDWA violations? Which communities face the greatest risks associated with drinking water? How would you use the statistical outputs (model summary, prediction figure) to describe that risk quantitatively? How could those statistical outputs be misinterpreted?**
